<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <title>Meal Planner</title>
</head>

<body>

    <div class="navbar">
        <ul>
            <input type="image" src="img/moon-btn.png" id="toggle-dark-mode" width="20" height="20" margin-right="10px" class="gumb">
            <li><a href="homepage.html">Home</a></li>
            <li><a href="#">Meal Plan</a></li>
            <button id="logoutButton" class="button">Logout</button>
        </ul>
    </div>

    <h1>Meal Planner</h1>

    <div>
        <div id="mealPlan">
            <div class="day" id="mondayDay">
                <h3>Monday</h3>
                <ul class="recipe-list" id="monday"></ul>
            </div>

            <div class="day" id="tuesdayDay">
                <h3>Tuesday</h3>
                <ul class="recipe-list" id="tuesday"></ul>
            </div>

            <div class="day" id="wednesdayDay">
                <h3>Wednesday</h3>
                <ul class="recipe-list" id="wednesday"></ul>
            </div>

            <div class="day" id="thursdayDay">
                <h3>Thursday</h3>
                <ul class="recipe-list" id="thursday"></ul>
            </div>

            <div class="day" id="fridayDay">
                <h3>Friday</h3>
                <ul class="recipe-list" id="friday"></ul>
            </div>

            <div class="day" id="saturdayDay">
                <h3>Saturday</h3>
                <ul class="recipe-list" id="saturday"></ul>
            </div>

            <div class="day" id="sundayDay">
                <h3>Sunday</h3>
                <ul class="recipe-list" id="sunday"></ul>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('toggle-dark-mode').addEventListener('click', async () => {
            const isDarkMode = await window.darkMode.toggle();
        })

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
  const selectedDay = urlParams.get('day');
  const accessToken = window.localStorage.getItem('accessToken');
  const refreshToken = window.localStorage.getItem('refreshToken');

  console.log(accessToken, refreshToken);

  if (!accessToken || !refreshToken) {
    window.location.href = 'login.html';
  } else {
    // Get the selected day from the query parameters
    const urlParams = new URLSearchParams(window.location.search);
    const selectedDay = urlParams.get('day');

    const allDayDivs = document.querySelectorAll('.day');
    const dayButtonsContainer = document.getElementById('mealPlan');

    if (!selectedDay) {
      // No day is selected, show buttons for each day
      const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

      daysOfWeek.forEach(dayOfWeek => {
        const dayButton = document.createElement('button');
        dayButton.textContent = dayOfWeek;
        dayButton.classList.add('day-button');
        dayButton.addEventListener('click', () => {
          handleDaySelection(dayOfWeek.toLowerCase());
          fetchRecipes(dayOfWeek.toLowerCase());

          // Hide all day divs
          allDayDivs.forEach(dayDiv => {
            dayDiv.style.display = 'none';
          });

          // Show the selected day div
          const selectedDayDiv = document.getElementById(`${dayOfWeek.toLowerCase()}Day`);
          if (selectedDayDiv) {
            selectedDayDiv.style.display = 'block';
          }
        });
        dayButtonsContainer.appendChild(dayButton);
      });

      // Hide all day divs
      allDayDivs.forEach(dayDiv => {
        dayDiv.style.display = 'none';
      });
    } else {
      // A day is selected
      // Show the selected day div
      const selectedDayDiv = document.getElementById(`${selectedDay.toLowerCase()}Day`);
      if (selectedDayDiv) {
        selectedDayDiv.style.display = 'block';
        selectedDayDiv.querySelector('h3').textContent = selectedDay;

        // Hide other day divs
        allDayDivs.forEach(dayDiv => {
          if (dayDiv !== selectedDayDiv) {
            dayDiv.style.display = 'none';
          }
        });

        fetchRecipes(selectedDay);
      }
    }
  }
});

function handleDaySelection(day) {
  // Redirect to the same page with the selected day as a query parameter
  const urlParams = new URLSearchParams(window.location.search);

  const dayString = day.charAt(0).toUpperCase() + day.slice(1);

  urlParams.set('day', dayString);
  const newUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;
  window.location.href = newUrl;
}



        // FETCH RECIPES
        async function fetchRecipes(day) {
            try {
                const response = await fetch(`http://localhost:3001/recipes/getDailyRecipe/${day}`);
                const recipes = await response.json();

                recipes.forEach(recipe => {
                    const recipeCard = document.createElement('div');
                    recipeCard.classList.add('recipe-card');

                    const name = document.createElement('h3');
                    name.textContent = recipe.name;
                    recipeCard.appendChild(name);

                    const ingredients = document.createElement('p');
                    ingredients.textContent = `Ingredients: ${recipe.ingredients.join(', ')}`;
                    recipeCard.appendChild(ingredients);

                    const preparation = document.createElement('p');
                    preparation.textContent = `Preparation: ${recipe.preparation.join(', ')}`;
                    recipeCard.appendChild(preparation);

                    const calories = document.createElement('p');
                    calories.textContent = `Calories: ${recipe.calories}`;
                    recipeCard.appendChild(calories);

                    const protein = document.createElement('p');
                    protein.textContent = `Protein: ${recipe.protein}`;
                    recipeCard.appendChild(protein);

                    const fat = document.createElement('p');
                    fat.textContent = `Fat: ${recipe.fat}`;
                    recipeCard.appendChild(fat);

                    const carbs = document.createElement('p');
                    carbs.textContent = `Carbs: ${recipe.carbs}`;
                    recipeCard.appendChild(carbs);

                    

                    // ADD DELETE BUTTON
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('delete-button');
                    recipeCard.appendChild(deleteButton);

                    // Event handler for recipe deletion
                    deleteButton.addEventListener('click', deleteRecipe(recipe, day));

                    document.getElementById(day.toLowerCase()).appendChild(recipeCard);
                });
                } catch (error) {
                console.log(error);
                }
            }

            // DELETE RECIPE
            function deleteRecipe(recipe, day) {
                        return async () => {
                            try {
                                // Prepare the payload for the PUT request
                                const payload = {
                                ...recipe,
                                dayOfTheWeek: ''
                                };
                                console.log(payload);

                                const putResponse = await fetch(`http://localhost:3001/recipes/updateRecipe/${recipe._id}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(payload)
                                });

                                if (putResponse.ok) {
                                    console.log(`Recipe "${recipe.name}" added to ${day}`);

                                    window.location.href = `mealplan.html?recipe=${recipe.name}&day=${day}`;
                                } else {
                                    console.log('Failed to add recipe to day:', putResponse.status);
                                }
                            } catch (error) {
                                console.log('Error adding recipe to day:', error);
                            }
                        };
                    }

        // ADD RECIPE TO DAY
        // async function addRecipeToDay(recipe, day) {
        //     try {
        //         const response = await fetch('http://localhost:3001/mealplan/addRecipe', {
        //             method: 'POST',
        //             headers: {
        //                 'Content-Type': 'application/json'
        //             },
        //             body: JSON.stringify({ recipe, day })
        //         });

        //         if (response.ok) {
        //             alert('Recipe added to the meal plan successfully.');
        //         } else {
        //             const data = await response.json();
        //             alert(data.error);
        //         }
        //     } catch (error) {
        //         console.log(error);
        //     }
        // }

        // LOGOUT
        const logoutButton = document.getElementById('logoutButton');

        logoutButton.addEventListener('click', async () => {
            const response = await fetch('http://localhost:3001/users/logout', {
                method: 'POST',
            });

            if (response.ok) {
                alert('Logout successful');
                // Redirect to the login page or any other desired page
                window.location.href = 'login.html';
            } else {
                const data = await response.json();
                alert(data.error);
            }
        });

    </script>
</body>

</html>
